:_content-type: CONCEPT
:imagesdir: ../../images

[id="overview-architecture"]
== Overview of the architectures

Figure 3 provides a schematic diagram overview of the complete solution including both components and data flows.

Subsequent schematic diagrams go into more detail on:

* Bootstrapping the management hub (Figure 4)
* Hybrid multi-cloud GitOps (Figure 5)
* Dynamic security management (Figure 6)
* Observability in hybrid multi-cloud environments (Figure 7)

image::multicloud-gitops/schema-gitops.png[Physical Architecture]

_Figure 3. Overview schematic diagram of the complete solution._

[id="bootstrapping-the-management-hub"]
=== Bootstrapping the management hub

image::multicloud-gitops/spi-multi-cloud-gitops-sd-install.png[Schematic diagram of bootstrapping the management hub]

_Figure 4. Schematic diagram of bootstrapping the management hub._

As detailed below, Figure 4 provides a schematic diagram showing the setup of the management hub using Ansible playbooks.

* Set up the Red Hat OpenShift Platform that hosts the Management Hub. The OpenShift installation program provides flexible ways to install OpenShift. An Ansible playbook kicks off the installation with necessary configurations.

* Ansible playbooks are again used to deploy and configure Red Hat Advanced Cluster Management for Kubernetes and, later, other supporting components (such as external secrets management) on top of the provisioned OpenShift cluster.

* Another Ansible playbook installs HashiCorp Vault, a Red Hat partner product chosen for this solution that can be used to manage secrets for OpenShift clusters.

* An Ansible playbook is used again to configure and trigger the Openshift GitOps operator on the hub cluster. This deploys the Openshift GitOps instance to enable continuous delivery.

[id="hybrid-multicloud-gitops"]
=== Hybrid multicloud GitOps

image::multicloud-gitops/spi-multi-cloud-gitops-sd-security.png[Schematic diagram of hybrid multi-cloud management with GitOps]

_Figure 5. Schematic diagram of hybrid multi-cloud management with GitOps._

As detailed below, Figure 5 provides a schematic diagram showing remaining activities associated with setting up the management hub and clusters using Red Hat Advanced Cluster Management.

* Manifest and configuration are set as code template in the form of "`Kustomization`" yaml. It describes the end desire state of how the managed cluster is going to be like. When done, it is pushed into the source control management repository with a version assigned to each update.
* OpenShift GitOps watches the repository and detects changes in the repository.
* OpenShift GitOps creates/updates the manifest by creating Kubernetes objects on top of Red Hat Advanced Cluster Management.
* Red Hat Advanced Cluster Management provision/update/delete managed clusters and configuration according to the manifest. In the manifest, you can configure what cloud provider the cluster will be on, the name of the cluster, infra node details and worker node. Governance policy can also be applied as well as provision an agent in the cluster as the bridge between the control center and the managed cluster.
* OpenShift GitOps will continuously watch between the code repository and status of the clusters reported back to Red Hat Advanced Cluster Management. Any configuration drift or in case of any failure, it will automatically try to remediate by applying the manifest (Or showing alerts for manual intervention).

[id="dynamic-security-management"]
=== Dynamic security management

image::multicloud-gitops/spi-multi-cloud-gitops-sd-security.png[Schematic showing the setup and use of external secrets management]

_Figure 6. Schematic showing the setup and use of external secrets management._

As detailed below, Figure 6 provides a schematic diagram showing how secrets are handled in this solution.

During setup, the token to securely access HashiCorp Vault is stored in Ansible Vault. It is encrypted to protect sensitive content.

Red Hat Advanced Cluster Management for Kubernetes allows us to have centralized control over the managed clusters. It acquires the token from Ansible Vault during install and distributes it among the clusters.

To allow the cluster access to the external vault, we need to set up the external secret management (with Helm in this study). OpenShift Gitops is used to deploy the external secret object to a managed cluster.

External secret management fetches secrets from HashiCorp Vault using the token we created in step 2 and constantly watches for updates.
Secrets are created in each namespace, where applications can use them.

Secrets are created in each namespace, where applications can use them.

[id="observability-in-hybrid-multicloud-environment"]
=== Observability in hybrid multicloud environment

image::multicloud-gitops/spi-multi-cloud-gitops-sd-monitoring.png[Schematic showing the use of Observatorium and other tools to add observability to the solution]

_Figure 7. Schematic showing the use of Observatorium and other tools to add observability to the solution._

As detailed below, Figure 7 provides a schematic diagram of integrating a variety of open source tools to implement observability.

* The Grafana dashboard in Hub cluster makes queries. The central Querier component in Observatorium processes the Prom. QL queries and aggregates the results.
* Prometheus scrapes metrics in the local cluster; a Thanos sidecar pushes metrics to Observatorium to persist in storage.
* A Thanos sidecar acts as a proxy that serves Prometheus's local data over Thanos's gRPC API from the Querier.
* Promtail is used to collect logs and push to Observatorium's Loki API.
* In Observatorium, the Loki distributor sends logs in batches to ingester, where they will be persisted. A couple of things to beware of: both ingester and querier require large memory consumption, will need more replicas.
* The Grafana dashboard in Hub cluster display logs via requesting: real-time display (tail) with WebSocket or a time-series-based query with HTTP.

For logical, physical and dataflow diagrams, see https://www.redhat.com/architect/portfolio/detail/8[Hybrid Multicloud Management with GitOps].

//AI:needs SME review
//[discrete]
//== Demo Scenario

[id="download-diagrams"]
== Download diagrams

View and download all of the diagrams above in our open source tooling site.

https://www.redhat.com/architect/portfolio/tool/index.html?#gitlab.com/osspa/portfolio-architecture-examples/-/raw/main/diagrams/spi-multi-cloud-gitops.drawio[Open Diagrams]